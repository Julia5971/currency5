<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‹¤ì‹œê°„ í™˜ìœ¨ ì •ë³´ ì„œë¹„ìŠ¤</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f5f5f5;
        }

        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-align: center;
            padding: 2rem 0;
            margin-bottom: 2rem;
        }

        header h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }

        main {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 2rem;
        }

        section {
            background: white;
            border-radius: 10px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        h2 {
            color: #667eea;
            margin-bottom: 1rem;
            font-size: 1.8rem;
        }

        #rate-list {
            list-style: none;
            margin: 1rem 0;
        }

        #rate-list li {
            padding: 0.5rem 0;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #rate-list li:last-child {
            border-bottom: none;
        }

        #rate-list span {
            font-weight: bold;
            color: #667eea;
        }

        #last-updated {
            color: #666;
            font-style: italic;
        }

        form {
            display: grid;
            gap: 1rem;
            max-width: 400px;
        }

        label {
            font-weight: bold;
            color: #555;
        }

        input {
            padding: 0.8rem;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
        }

        input:focus {
            outline: none;
            border-color: #667eea;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem 2rem;
            border: none;
            border-radius: 5px;
            font-size: 1rem;
            cursor: pointer;
            transition: transform 0.2s;
        }

        button:hover {
            transform: translateY(-2px);
        }

        #calculation-result {
            margin-top: 1rem;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 5px;
            font-weight: bold;
            text-align: center;
        }

        #rate-chart {
            width: 100%;
            height: 300px;
            margin: 1rem 0;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        #rate-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        #rate-table th,
        #rate-table td {
            padding: 0.8rem;
            text-align: center;
            border: 1px solid #ddd;
        }

        #rate-table th {
            background: #667eea;
            color: white;
        }

        #rate-table tr:nth-child(even) {
            background: #f8f9fa;
        }

        footer {
            text-align: center;
            padding: 2rem;
            background: white;
            margin-top: 2rem;
        }

        footer p {
            margin-bottom: 1rem;
            color: #666;
        }

        @media (max-width: 768px) {
            main {
                padding: 0 1rem;
            }

            header h1 {
                font-size: 2rem;
            }

            section {
                padding: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>ğŸŒ ì‹¤ì‹œê°„ í™˜ìœ¨ ì •ë³´ ì„œë¹„ìŠ¤</h1>
    </header>

    <main>
        <section id="real-time-rates">
            <h2>ì‹¤ì‹œê°„ í™˜ìœ¨</h2>
            <p>ê¸°ì¤€ í†µí™”: USD (ë¯¸êµ­ ë‹¬ëŸ¬)</p>
            <ul id="rate-list">
                <li>KRW (ëŒ€í•œë¯¼êµ­ ì›): <span>-</span></li>
                <li>EUR (ìœ ë¡œ): <span>-</span></li>
                <li>JPY (ì¼ë³¸ ì—”): <span>-</span></li>
                <li>CNY (ì¤‘êµ­ ìœ„ì•ˆ): <span>-</span></li>
            </ul>
            <small id="last-updated">ìµœì¢… ì—…ë°ì´íŠ¸: -</small>
        </section>

        <section id="profit-calculator">
            <h2>í™˜ì°¨ì† ê³„ì‚°ê¸°</h2>
            <form id="calculator-form">
                <div>
                    <label for="purchase-price">ë§¤ì… í™˜ìœ¨ (KRW):</label>
                    <input type="number" id="purchase-price" placeholder="ì˜ˆ: 1300.50" step="0.01">
                </div>
                <div>
                    <label for="amount">í™˜ì „ ê¸ˆì•¡ (USD):</label>
                    <input type="number" id="amount" placeholder="ì˜ˆ: 100">
                </div>
                <div style="margin-top: 1rem;">
                    <button type="submit">ê³„ì‚°í•˜ê¸°</button>
                </div>
            </form>
            <p id="calculation-result">ê²°ê³¼: -</p>
        </section>

        <section id="historical-data">
            <h2>ê³¼ê±° í™˜ìœ¨ ë°ì´í„° (ìµœê·¼ 30ì¼)</h2>
            <canvas id="rate-chart"></canvas>
            <table id="rate-table">
                <thead>
                    <tr>
                        <th>ë‚ ì§œ</th>
                        <th>KRW</th>
                        <th>EUR</th>
                        <th>JPY</th>
                        <th>CNY</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- ë°ì´í„°ëŠ” JavaScriptë¡œ ì±„ì›Œì§‘ë‹ˆë‹¤. -->
                </tbody>
            </table>
        </section>
    </main>

    <footer>
        <p>ë°ì´í„° ì¶œì²˜: ExchangeRate-API</p>
        <button id="print-button">ì •ë³´ ì¸ì‡„í•˜ê¸°</button>
    </footer>

    <script src="../node_modules/chart.js/dist/chart.umd.js"></script>
    <script type="module">
        import { fetchExchangeRates } from './services/ExchangeRateService.js';
        import { calculateProfitLoss } from './calculators/ProfitCalculator.js';
        import { DeveloperModeService } from './services/DeveloperModeService.js';
        import { ChartService } from './services/ChartService.js';

        const developerMode = new DeveloperModeService();

        // DOM ìš”ì†Œë“¤
        const rateList = document.getElementById('rate-list');
        const lastUpdated = document.getElementById('last-updated');
        const calculatorForm = document.getElementById('calculator-form');
        const calculationResult = document.getElementById('calculation-result');
        const printButton = document.getElementById('print-button');
        const rateChart = document.getElementById('rate-chart');
        const rateTable = document.getElementById('rate-table');

        // ì „ì—­ ë³€ìˆ˜ë¡œ í˜„ì¬ í™˜ìœ¨ ë°ì´í„° ì €ì¥
        let currentExchangeRates = null;
        let chartService = null;

        // ì‹¤ì‹œê°„ í™˜ìœ¨ ë°ì´í„° ë¡œë“œ
        async function loadExchangeRates() {
            try {
                developerMode.logIfDeveloperMode('í™˜ìœ¨ ë°ì´í„° ë¡œë”© ì‹œì‘');
                
                const data = await fetchExchangeRates();
                currentExchangeRates = data; // ì „ì—­ ë³€ìˆ˜ì— ì €ì¥
                
                // í™˜ìœ¨ ì •ë³´ ì—…ë°ì´íŠ¸
                const currencies = ['KRW', 'EUR', 'JPY', 'CNY'];
                currencies.forEach(currency => {
                    const rate = data.rates[currency];
                    if (rate) {
                        // li ìš”ì†Œì—ì„œ í•´ë‹¹ í†µí™”ë¥¼ ì°¾ê¸°
                        const listItems = rateList.querySelectorAll('li');
                        listItems.forEach(item => {
                            if (item.textContent.includes(currency)) {
                                const span = item.querySelector('span');
                                if (span) {
                                    span.textContent = rate.toFixed(2);
                                }
                            }
                        });
                    }
                });

                // ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸ ì‹œê°„
                lastUpdated.textContent = `ìµœì¢… ì—…ë°ì´íŠ¸: ${new Date().toLocaleString()} (${data.source})`;
                
                developerMode.logIfDeveloperMode('í™˜ìœ¨ ë°ì´í„° ë¡œë”© ì™„ë£Œ:', data);
                
            } catch (error) {
                developerMode.logIfDeveloperMode('í™˜ìœ¨ ë°ì´í„° ë¡œë”© ì‹¤íŒ¨:', error);
                console.error('í™˜ìœ¨ ë°ì´í„° ë¡œë”© ì‹¤íŒ¨:', error);
            }
        }

        // í™˜ì°¨ì† ê³„ì‚°
        function handleCalculation(event) {
            event.preventDefault();
            
            let purchasePrice = parseFloat(document.getElementById('purchase-price').value);
            let amount = parseFloat(document.getElementById('amount').value);
            
            // ë¹ˆ ê°’ì´ë©´ ê¸°ë³¸ê°’ ì‚¬ìš©
            if (isNaN(purchasePrice)) {
                purchasePrice = 1300.50;
                document.getElementById('purchase-price').value = purchasePrice;
                developerMode.logIfDeveloperMode('ë§¤ì… í™˜ìœ¨ì´ ë¹„ì–´ìˆì–´ ê¸°ë³¸ê°’ ì‚¬ìš©:', purchasePrice);
            }
            
            if (isNaN(amount)) {
                amount = 100;
                document.getElementById('amount').value = amount;
                developerMode.logIfDeveloperMode('í™˜ì „ ê¸ˆì•¡ì´ ë¹„ì–´ìˆì–´ ê¸°ë³¸ê°’ ì‚¬ìš©:', amount);
            }

            // í˜„ì¬ í™˜ìœ¨ (ì‹¤ì œ API ë°ì´í„° ì‚¬ìš©)
            const currentPrice = currentExchangeRates?.rates?.KRW || 1350;
            
            developerMode.logIfDeveloperMode('í™˜ì°¨ì† ê³„ì‚° ì‹¤í–‰:', {
                purchasePrice,
                currentPrice,
                amount,
                purchasePriceInput: document.getElementById('purchase-price').value,
                amountInput: document.getElementById('amount').value
            });
            
            const profit = calculateProfitLoss(purchasePrice, currentPrice, amount);
            
            developerMode.logIfDeveloperMode('í™˜ì°¨ì† ê³„ì‚° ê²°ê³¼:', profit);
            
            if (profit > 0) {
                calculationResult.textContent = `í™˜ì°¨ìµ: +${profit.toLocaleString()}ì›`;
                calculationResult.style.color = 'green';
            } else if (profit < 0) {
                calculationResult.textContent = `í™˜ì°¨ì†: ${profit.toLocaleString()}ì›`;
                calculationResult.style.color = 'red';
            } else {
                calculationResult.textContent = 'í™˜ì°¨ìµ/ì†: 0ì›';
                calculationResult.style.color = 'black';
            }
        }



        // ì¸ì‡„ ê¸°ëŠ¥
        async function handlePrint() {
            await developerMode.logIfDeveloperMode('ì¸ì‡„ ê¸°ëŠ¥ ì‹¤í–‰');
            window.print();
        }

        // ì°¨íŠ¸ ì´ˆê¸°í™”
        async function initializeChart() {
            try {
                await developerMode.logIfDeveloperMode('ì°¨íŠ¸ ì´ˆê¸°í™” ì‹œì‘');
                chartService = new ChartService();
                await chartService.initializeChart(rateChart);
                
                // ìƒ˜í”Œ ë°ì´í„°ë¡œ ì°¨íŠ¸ í…ŒìŠ¤íŠ¸
                const sampleData = await chartService.loadSampleData();
                
                // í…Œì´ë¸”ë„ ì—…ë°ì´íŠ¸
                updateRateTable(sampleData);
                
                await developerMode.logIfDeveloperMode('ì°¨íŠ¸ ì´ˆê¸°í™” ì™„ë£Œ');
            } catch (error) {
                await developerMode.logIfDeveloperMode('ì°¨íŠ¸ ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
                console.error('ì°¨íŠ¸ ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
            }
        }

        // í™˜ìœ¨ í…Œì´ë¸” ì—…ë°ì´íŠ¸
        async function updateRateTable(historicalData) {
            try {
                await developerMode.logIfDeveloperMode('í™˜ìœ¨ í…Œì´ë¸” ì—…ë°ì´íŠ¸ ì‹œì‘');
                
                const tbody = rateTable.querySelector('tbody');
                tbody.innerHTML = '';
                
                // ìµœê·¼ 10ì¼ ë°ì´í„°ë§Œ í‘œì‹œ
                const recentData = historicalData.slice(-10);
                
                recentData.forEach(item => {
                    const row = document.createElement('tr');
                    
                    const dateCell = document.createElement('td');
                    const date = new Date(item.date);
                    dateCell.textContent = date.toLocaleDateString('ko-KR');
                    row.appendChild(dateCell);
                    
                    ['KRW', 'EUR', 'JPY', 'CNY'].forEach(currency => {
                        const cell = document.createElement('td');
                        const rate = item.rates[currency];
                        cell.textContent = rate ? rate.toFixed(2) : '-';
                        row.appendChild(cell);
                    });
                    
                    tbody.appendChild(row);
                });
                
                await developerMode.logIfDeveloperMode('í™˜ìœ¨ í…Œì´ë¸” ì—…ë°ì´íŠ¸ ì™„ë£Œ', recentData.length);
            } catch (error) {
                await developerMode.logIfDeveloperMode('í™˜ìœ¨ í…Œì´ë¸” ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error);
                console.error('í™˜ìœ¨ í…Œì´ë¸” ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error);
            }
        }

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
        calculatorForm.addEventListener('submit', handleCalculation);
        printButton.addEventListener('click', handlePrint);

        // í˜ì´ì§€ ë¡œë“œ ì‹œ í™˜ìœ¨ ë°ì´í„° ë¡œë“œ
        document.addEventListener('DOMContentLoaded', async () => {
            await developerMode.logIfDeveloperMode('í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ');
            loadExchangeRates();
            
            // Chart.js ë¡œë”© í™•ì¸ í›„ ì°¨íŠ¸ ì´ˆê¸°í™”
            if (typeof Chart !== 'undefined') {
                await initializeChart();
            } else {
                await developerMode.logIfDeveloperMode('Chart.js ë¡œë”© ëŒ€ê¸° ì¤‘...');
                setTimeout(async () => {
                    if (typeof Chart !== 'undefined') {
                        await initializeChart();
                    } else {
                        console.error('Chart.js ë¡œë”© ì‹¤íŒ¨');
                    }
                }, 1000);
            }
        });

        // 5ë¶„ë§ˆë‹¤ í™˜ìœ¨ ë°ì´í„° ìƒˆë¡œê³ ì¹¨
        setInterval(loadExchangeRates, 5 * 60 * 1000);
    </script>
</body>
</html>
