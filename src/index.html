<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>실시간 환율 정보 서비스</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f5f5f5;
        }

        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-align: center;
            padding: 2rem 0;
            margin-bottom: 2rem;
        }

        header h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }

        main {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 2rem;
        }

        section {
            background: white;
            border-radius: 10px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        h2 {
            color: #667eea;
            margin-bottom: 1rem;
            font-size: 1.8rem;
        }

        #rate-list {
            list-style: none;
            margin: 1rem 0;
        }

        #rate-list li {
            padding: 0.5rem 0;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #rate-list li:last-child {
            border-bottom: none;
        }

        #rate-list span {
            font-weight: bold;
            color: #667eea;
        }

        #last-updated {
            color: #666;
            font-style: italic;
        }

        form {
            display: grid;
            gap: 1rem;
            max-width: 400px;
        }

        label {
            font-weight: bold;
            color: #555;
        }

        input {
            padding: 0.8rem;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
        }

        input:focus {
            outline: none;
            border-color: #667eea;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem 2rem;
            border: none;
            border-radius: 5px;
            font-size: 1rem;
            cursor: pointer;
            transition: transform 0.2s;
        }

        button:hover {
            transform: translateY(-2px);
        }

        #calculation-result {
            margin-top: 1rem;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 5px;
            font-weight: bold;
            text-align: center;
        }

        #rate-chart {
            width: 100%;
            height: 300px;
            margin: 1rem 0;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        #rate-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        #rate-table th,
        #rate-table td {
            padding: 0.8rem;
            text-align: center;
            border: 1px solid #ddd;
        }

        #rate-table th {
            background: #667eea;
            color: white;
        }

        #rate-table tr:nth-child(even) {
            background: #f8f9fa;
        }

        footer {
            text-align: center;
            padding: 2rem;
            background: white;
            margin-top: 2rem;
        }

        footer p {
            margin-bottom: 1rem;
            color: #666;
        }

        @media (max-width: 768px) {
            main {
                padding: 0 1rem;
            }

            header h1 {
                font-size: 2rem;
            }

            section {
                padding: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>🌍 실시간 환율 정보 서비스</h1>
    </header>

    <main>
        <section id="real-time-rates">
            <h2>실시간 환율</h2>
            <p>기준 통화: USD (미국 달러)</p>
            <ul id="rate-list">
                <li>KRW (대한민국 원): <span>-</span></li>
                <li>EUR (유로): <span>-</span></li>
                <li>JPY (일본 엔): <span>-</span></li>
                <li>CNY (중국 위안): <span>-</span></li>
            </ul>
            <small id="last-updated">최종 업데이트: -</small>
        </section>

        <section id="profit-calculator">
            <h2>환차손 계산기</h2>
            <form id="calculator-form">
                <div>
                    <label for="purchase-price">매입 환율 (KRW):</label>
                    <input type="number" id="purchase-price" placeholder="예: 1300.50" step="0.01">
                </div>
                <div>
                    <label for="amount">환전 금액 (USD):</label>
                    <input type="number" id="amount" placeholder="예: 100">
                </div>
                <div style="margin-top: 1rem;">
                    <button type="submit">계산하기</button>
                </div>
            </form>
            <p id="calculation-result">결과: -</p>
        </section>

        <section id="historical-data">
            <h2>과거 환율 데이터 (최근 30일)</h2>
            <canvas id="rate-chart"></canvas>
            <table id="rate-table">
                <thead>
                    <tr>
                        <th>날짜</th>
                        <th>KRW</th>
                        <th>EUR</th>
                        <th>JPY</th>
                        <th>CNY</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- 데이터는 JavaScript로 채워집니다. -->
                </tbody>
            </table>
        </section>
    </main>

    <footer>
        <p>데이터 출처: ExchangeRate-API</p>
        <button id="print-button">정보 인쇄하기</button>
    </footer>

    <script src="../node_modules/chart.js/dist/chart.umd.js"></script>
    <script type="module">
        import { fetchExchangeRates } from './services/ExchangeRateService.js';
        import { calculateProfitLoss } from './calculators/ProfitCalculator.js';
        import { DeveloperModeService } from './services/DeveloperModeService.js';
        import { ChartService } from './services/ChartService.js';

        const developerMode = new DeveloperModeService();

        // DOM 요소들
        const rateList = document.getElementById('rate-list');
        const lastUpdated = document.getElementById('last-updated');
        const calculatorForm = document.getElementById('calculator-form');
        const calculationResult = document.getElementById('calculation-result');
        const printButton = document.getElementById('print-button');
        const rateChart = document.getElementById('rate-chart');
        const rateTable = document.getElementById('rate-table');

        // 전역 변수로 현재 환율 데이터 저장
        let currentExchangeRates = null;
        let chartService = null;

        // 실시간 환율 데이터 로드
        async function loadExchangeRates() {
            try {
                developerMode.logIfDeveloperMode('환율 데이터 로딩 시작');
                
                const data = await fetchExchangeRates();
                currentExchangeRates = data; // 전역 변수에 저장
                
                // 환율 정보 업데이트
                const currencies = ['KRW', 'EUR', 'JPY', 'CNY'];
                currencies.forEach(currency => {
                    const rate = data.rates[currency];
                    if (rate) {
                        // li 요소에서 해당 통화를 찾기
                        const listItems = rateList.querySelectorAll('li');
                        listItems.forEach(item => {
                            if (item.textContent.includes(currency)) {
                                const span = item.querySelector('span');
                                if (span) {
                                    span.textContent = rate.toFixed(2);
                                }
                            }
                        });
                    }
                });

                // 마지막 업데이트 시간
                lastUpdated.textContent = `최종 업데이트: ${new Date().toLocaleString()} (${data.source})`;
                
                developerMode.logIfDeveloperMode('환율 데이터 로딩 완료:', data);
                
            } catch (error) {
                developerMode.logIfDeveloperMode('환율 데이터 로딩 실패:', error);
                console.error('환율 데이터 로딩 실패:', error);
            }
        }

        // 환차손 계산
        function handleCalculation(event) {
            event.preventDefault();
            
            let purchasePrice = parseFloat(document.getElementById('purchase-price').value);
            let amount = parseFloat(document.getElementById('amount').value);
            
            // 빈 값이면 기본값 사용
            if (isNaN(purchasePrice)) {
                purchasePrice = 1300.50;
                document.getElementById('purchase-price').value = purchasePrice;
                developerMode.logIfDeveloperMode('매입 환율이 비어있어 기본값 사용:', purchasePrice);
            }
            
            if (isNaN(amount)) {
                amount = 100;
                document.getElementById('amount').value = amount;
                developerMode.logIfDeveloperMode('환전 금액이 비어있어 기본값 사용:', amount);
            }

            // 현재 환율 (실제 API 데이터 사용)
            const currentPrice = currentExchangeRates?.rates?.KRW || 1350;
            
            developerMode.logIfDeveloperMode('환차손 계산 실행:', {
                purchasePrice,
                currentPrice,
                amount,
                purchasePriceInput: document.getElementById('purchase-price').value,
                amountInput: document.getElementById('amount').value
            });
            
            const profit = calculateProfitLoss(purchasePrice, currentPrice, amount);
            
            developerMode.logIfDeveloperMode('환차손 계산 결과:', profit);
            
            if (profit > 0) {
                calculationResult.textContent = `환차익: +${profit.toLocaleString()}원`;
                calculationResult.style.color = 'green';
            } else if (profit < 0) {
                calculationResult.textContent = `환차손: ${profit.toLocaleString()}원`;
                calculationResult.style.color = 'red';
            } else {
                calculationResult.textContent = '환차익/손: 0원';
                calculationResult.style.color = 'black';
            }
        }



        // 인쇄 기능
        async function handlePrint() {
            await developerMode.logIfDeveloperMode('인쇄 기능 실행');
            window.print();
        }

        // 차트 초기화
        async function initializeChart() {
            try {
                await developerMode.logIfDeveloperMode('차트 초기화 시작');
                chartService = new ChartService();
                await chartService.initializeChart(rateChart);
                
                // 샘플 데이터로 차트 테스트
                const sampleData = await chartService.loadSampleData();
                
                // 테이블도 업데이트
                updateRateTable(sampleData);
                
                await developerMode.logIfDeveloperMode('차트 초기화 완료');
            } catch (error) {
                await developerMode.logIfDeveloperMode('차트 초기화 실패:', error);
                console.error('차트 초기화 실패:', error);
            }
        }

        // 환율 테이블 업데이트
        async function updateRateTable(historicalData) {
            try {
                await developerMode.logIfDeveloperMode('환율 테이블 업데이트 시작');
                
                const tbody = rateTable.querySelector('tbody');
                tbody.innerHTML = '';
                
                // 최근 10일 데이터만 표시
                const recentData = historicalData.slice(-10);
                
                recentData.forEach(item => {
                    const row = document.createElement('tr');
                    
                    const dateCell = document.createElement('td');
                    const date = new Date(item.date);
                    dateCell.textContent = date.toLocaleDateString('ko-KR');
                    row.appendChild(dateCell);
                    
                    ['KRW', 'EUR', 'JPY', 'CNY'].forEach(currency => {
                        const cell = document.createElement('td');
                        const rate = item.rates[currency];
                        cell.textContent = rate ? rate.toFixed(2) : '-';
                        row.appendChild(cell);
                    });
                    
                    tbody.appendChild(row);
                });
                
                await developerMode.logIfDeveloperMode('환율 테이블 업데이트 완료', recentData.length);
            } catch (error) {
                await developerMode.logIfDeveloperMode('환율 테이블 업데이트 실패:', error);
                console.error('환율 테이블 업데이트 실패:', error);
            }
        }

        // 이벤트 리스너 등록
        calculatorForm.addEventListener('submit', handleCalculation);
        printButton.addEventListener('click', handlePrint);

        // 페이지 로드 시 환율 데이터 로드
        document.addEventListener('DOMContentLoaded', async () => {
            await developerMode.logIfDeveloperMode('페이지 로드 완료');
            loadExchangeRates();
            
            // Chart.js 로딩 확인 후 차트 초기화
            if (typeof Chart !== 'undefined') {
                await initializeChart();
            } else {
                await developerMode.logIfDeveloperMode('Chart.js 로딩 대기 중...');
                setTimeout(async () => {
                    if (typeof Chart !== 'undefined') {
                        await initializeChart();
                    } else {
                        console.error('Chart.js 로딩 실패');
                    }
                }, 1000);
            }
        });

        // 5분마다 환율 데이터 새로고침
        setInterval(loadExchangeRates, 5 * 60 * 1000);
    </script>
</body>
</html>
